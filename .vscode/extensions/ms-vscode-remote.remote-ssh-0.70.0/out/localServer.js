(()=>{"use strict";var e={8422:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isWindows=void 0,t.isWindows="win32"===process.platform},3759:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.parseStringMap=t.stripAllNewlines=t.escapeRegExpCharacters=t.splitLines=t.markLine=t.markLines=t.sanitizeConnectionToken=t.sanitizeInstallScriptOutput=t.stripTrailingNewline=t.quoteForShellIfNeeded=t.quoteForShell=t.stripEscapeSequences=t.lastNonemptyLine=void 0;const r=n(8422);function s(e){return e.replace(/\x1b\[\??[0-9]{0,3}(;[0-9]{1,3})?[a-zA-Z]/g,"").replace(/\u0008/g,"").replace(/\r/g,"")}function i(e,t){return t?`"${e}"`:`'${e}'`}function o(e){return e.replace(/\r?\n$/,"")}function a(e){return e.replace(/[a-z]/g,"a").replace(/[A-Z]/g,"A").replace(/[0-9]/g,"1")}function c(e){return e.split(/\r?\n/g)}t.lastNonemptyLine=function(e){const t=c(e);if(r.isWindows){let e="";for(let n=t.length-1;n>=0;n--){const r=s(t[n]);if(r.match(/The process tried to write to a nonexistent pipe/))e=r;else if(r)return r}if(e)return e}const n=t.filter((e=>!!e));return n[n.length-1]},t.stripEscapeSequences=s,t.quoteForShell=i,t.quoteForShellIfNeeded=function(e,t){return e.match(/[^a-z0-9]/)?i(e,t):e},t.stripTrailingNewline=o,t.sanitizeInstallScriptOutput=function(e){return function(e){return e.replace(/connectionToken==(.*)==/,((e,t)=>`connectionToken==${a(t)}==`))}(e)},t.sanitizeConnectionToken=a,t.markLines=function(e,t=""){return c(o(e)).map((e=>`${t}> ${e}`)).join("\n")},t.markLine=function(e,t=""){return`${t}> ${e}`},t.splitLines=c,t.escapeRegExpCharacters=function(e){return e.replace(/[\\\{\}\*\+\?\|\^\$\.\[\]\(\)]/g,"\\$&")},t.stripAllNewlines=function(e){return e.replace(/\r?\n/,"")},t.parseStringMap=function(e,t="==",n){e=e.trim().replace(/\r?\n/g,"");const r={};for(let s=0;s<e.length;){const i=e.indexOf(t,s),o=e.indexOf(t,i+t.length);if(-1===i||-1===o)return n.trace("Stopped parsing output early. Remaining text: "+e.substring(s)),r;const a=e.slice(i+t.length,o);r[e.slice(s,i)]=a,s=o+t.length;const c=e.substr(s).match(/^\s+/);c&&c[0]&&(s+=c[0].length)}return r}},3129:e=>{e.exports=require("child_process")},7619:e=>{e.exports=require("constants")},5747:e=>{e.exports=require("fs")},8605:e=>{e.exports=require("http")},8835:e=>{e.exports=require("url")}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}var r={};(()=>{var e=r;Object.defineProperty(e,"__esModule",{value:!0});const t=n(3129),s=n(7619),i=n(5747),o=n(8605),a=n(8835),c=n(3759),l=JSON.parse(process.argv[2]);let p=!1;function u(e,t,n,r){t.writeHead(n,{"Content-Type":"text/plain"}),t.end(r)}function d(e){console.log(c.markLines(e,"local-server-"+l.serverId))}function h(e){console.error(c.markLines(e,"local-server-"+l.serverId))}class f{constructor(){this.child=f.spawnSsh()}dispose(){this.child.kill()}static spawnSsh(){const e=t.spawn(l.sshCommand,l.sshArgs,{stdio:["inherit","pipe","pipe"],windowsHide:!0});let n=!1;return e.stdout.on("data",(e=>{n||process.stdout.write(e),e.toString().includes(": end")&&(n=!0)})),e.stderr.on("data",(e=>{n||process.stderr.write(e)})),e.on("exit",(()=>{p||(d("ssh child died, shutting down"),process.exit(0))})),d(`Spawned ssh, pid=${e.pid}`),e}}const g=new class{constructor(e){this.ipcHandlePath=e,this.server=o.createServer(((e,t)=>this.onRequest(e,t)));try{this.server.listen(this.ipcHandlePath),this.server.on("error",(e=>h(e.message)))}catch(e){h("Could not launch management server."),process.exit(1)}this.delayShutdown()}delayShutdown(){this.shutdownTimer&&clearTimeout(this.shutdownTimer),this.shutdownTimer=setTimeout((()=>{this.dispose(),m(),d("Timed out"),process.exit(0)}),5e3)}onRequest(e,t){if("GET"!==e.method)return t.writeHead(405,{"Content-Type":"text/plain"}),t.end(`Unsupported method ${e.method}`);if(!e.url)return u(0,t,400,"Bad request.");const n=a.parse(e.url,!0).pathname;return n?"/delay-shutdown"===n?(this.delayShutdown(),t.writeHead(200),void t.end("OK")):(t.writeHead(404,{"Content-Type":"text/plain"}),t.end("Not found")):u(0,t,400,"Bad request.")}dispose(){this.server.close()}}(l.ipcHandlePath),w=new f;function m(){if(p=!0,g.dispose(),w.dispose(),l.dataFilePath&&i.existsSync(l.dataFilePath))try{const e=i.readFileSync(l.dataFilePath);JSON.parse(e.toString()).pid===process.pid&&i.unlinkSync(l.dataFilePath)}catch(e){}}process.on("exit",(()=>{m()})),process.on("SIGTERM",(()=>{m(),process.exit(s.SIGTERM)}))})();var s=exports;for(var i in r)s[i]=r[i];r.__esModule&&Object.defineProperty(s,"__esModule",{value:!0})})();
//# sourceMappingURL=localServer.js.map